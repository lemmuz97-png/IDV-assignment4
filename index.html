
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDV Assignment 4 - Robustness Metric Heatmap</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind for the default light theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-accent': '#4f46e5', // Indigo
                    },
                }
            }
        }
    </script>
    <!-- Load D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Define the font and base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }

        /* Tooltip styling */
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px 12px;
            font-size: 14px;
            background: #1f2937; /* Dark background for contrast */
            color: #ffffff;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        /* Style for the heatmap cells */
        .cell {
            stroke: #ffffff;
            stroke-width: 1px;
            cursor: pointer;
        }

        /* Style for the axis text */
        .axis-label {
            font-weight: 500;
            font-size: 12px;
            fill: #374151;
        }

        /* Style the dropdown */
        #metric-select {
            padding: 8px 12px;
            border: 2px solid #6366f1; /* Indigo accent */
            border-radius: 8px;
            background-color: #ffffff;
            cursor: pointer;
            transition: all 0.2s;
        }

        #metric-select:hover {
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Robustness Performance Across Models and Datasets</h1>
            <p class="text-xl text-gray-500 mt-2">Heatmap Visualization of Standard Accuracy (Std Acc), Certified Robustness Rate (CRR), and Certified Robust Accuracy (CRA)</p>
        </header>

        <!-- Interaction Control: Dropdown for Metric Selection -->
        <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-8 mb-8 p-4 bg-white rounded-xl shadow-lg">
            <label for="metric-select" class="text-lg font-semibold text-indigo-600">Select Performance Metric:</label>
            <select id="metric-select" class="shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="Std Acc">Standard Accuracy (Std Acc)</option>
                <option value="CRR">Certified Robustness Rate (CRR)</option>
                <option value="CRA">Certified Robust Accuracy (CRA)</option>
            </select>
        </div>

        <!-- Visualization Container -->
        <div id="visualization-container" class="bg-white p-6 rounded-xl shadow-2xl">
            <svg id="heatmap"></svg>
        </div>

        <!-- Tooltip Element -->
        <div class="tooltip" id="tooltip"></div>

        <!-- Legend -->
        <div id="legend-container" class="mt-8 p-6 bg-white rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold mb-2">Color Scale (Percentage Value)</h3>
            <svg id="legend" width="300" height="40"></svg>
        </div>
    </div>

    <script>
        // Data Option 1 - Transformed into long format for D3.js (Value is already in percentage)
        const rawData = [
            {"Approach": "ERM", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 81.03},
            {"Approach": "DA", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 78.27},
            {"Approach": "PGDT", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 64.35},
            {"Approach": "TRADES", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 62.55},
            {"Approach": "MART", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 63.68},
            {"Approach": "RS", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 56.87},
            {"Approach": "IBP", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 39.45},
            {"Approach": "PRL", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 64.89},
            {"Approach": "TandT", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 65.56},
            {"Approach": "ERM", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 94.85},
            {"Approach": "DA", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 94.21},
            {"Approach": "PGDT", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 84.38},
            {"Approach": "TRADES", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 80.42},
            {"Approach": "MART", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 81.54},
            {"Approach": "RS", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 89.45},
            {"Approach": "IBP", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 48.4},
            {"Approach": "PRL", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 93.82},
            {"Approach": "TandT", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 94.23},
            {"Approach": "ERM", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 94.44},
            {"Approach": "DA", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 94.69},
            {"Approach": "PGDT", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 91.19},
            {"Approach": "TRADES", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 86.16},
            {"Approach": "MART", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 90.2},
            {"Approach": "RS", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 88.35},
            {"Approach": "IBP", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 73.09},
            {"Approach": "PRL", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 92},
            {"Approach": "TandT", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 94.79},
            {"Approach": "ERM", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.37},
            {"Approach": "DA", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.42},
            {"Approach": "PGDT", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.16},
            {"Approach": "TRADES", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.1},
            {"Approach": "MART", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 98.94},
            {"Approach": "RS", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 97.16},
            {"Approach": "IBP", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 97.78},
            {"Approach": "PRL", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.32},
            {"Approach": "TandT", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.32},
            {"Approach": "ERM", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 9.28},
            {"Approach": "DA", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 15.04},
            {"Approach": "PGDT", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 57.07},
            {"Approach": "TRADES", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 59.27},
            {"Approach": "MART", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 58.79},
            {"Approach": "RS", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 60.38},
            {"Approach": "IBP", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 49.34},
            {"Approach": "PRL", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 56.71},
            {"Approach": "TandT", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 62.05},
            {"Approach": "ERM", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 1.25},
            {"Approach": "DA", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 81.08},
            {"Approach": "PGDT", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 87.07},
            {"Approach": "TRADES", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 88.54},
            {"Approach": "MART", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 78.9},
            {"Approach": "RS", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 90},
            {"Approach": "IBP", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 54.7},
            {"Approach": "PRL", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 90.71},
            {"Approach": "TandT", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 95.08},
            {"Approach": "ERM", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 52.72},
            {"Approach": "DA", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 82.08},
            {"Approach": "PGDT", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 87.89},
            {"Approach": "TRADES", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 87.89},
            {"Approach": "MART", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 85.23},
            {"Approach": "RS", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 76.29},
            {"Approach": "IBP", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 61.94},
            {"Approach": "PRL", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 93.11},
            {"Approach": "TandT", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 93.15},
            {"Approach": "ERM", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 26.01},
            {"Approach": "DA", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 85.23},
            {"Approach": "PGDT", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 94.65},
            {"Approach": "TRADES", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 94.76},
            {"Approach": "MART", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 94.13},
            {"Approach": "RS", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 87.15},
            {"Approach": "IBP", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 89.18},
            {"Approach": "PRL", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 96.03},
            {"Approach": "TandT", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 97.8},
            {"Approach": "ERM", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 4.52},
            {"Approach": "DA", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 6.15},
            {"Approach": "PGDT", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 32.93},
            {"Approach": "TRADES", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 38.85},
            {"Approach": "MART", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 49.37},
            {"Approach": "RS", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 47.5},
            {"Approach": "IBP", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 29.2},
            {"Approach": "PRL", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 50.77},
            {"Approach": "TandT", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 52.07},
            {"Approach": "ERM", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 1.25},
            {"Approach": "DA", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 76.07},
            {"Approach": "PGDT", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 82.9},
            {"Approach": "TRADES", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 78.8},
            {"Approach": "MART", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 72.21},
            {"Approach": "RS", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 87.98},
            {"Approach": "IBP", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 40},
            {"Approach": "PRL", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 90.63},
            {"Approach": "TandT", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 91.75},
            {"Approach": "ERM", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 51.04},
            {"Approach": "DA", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 82.01},
            {"Approach": "PGDT", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 86.68},
            {"Approach": "TRADES", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 84.76},
            {"Approach": "MART", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 78.82},
            {"Approach": "RS", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 70.64},
            {"Approach": "IBP", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 57.26},
            {"Approach": "PRL", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 91.07},
            {"Approach": "TandT", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 92.81},
            {"Approach": "ERM", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 24.96},
            {"Approach": "DA", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 84.12},
            {"Approach": "PGDT", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 94.63},
            {"Approach": "TRADES", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 94.61},
            {"Approach": "MART", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 94.09},
            {"Approach": "RS", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 86.29},
            {"Approach": "IBP", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 88.51},
            {"Approach": "PRL", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 95.01},
            {"Approach": "TandT", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 96.8}
        ];

        // Dimensions
        const margin = { top: 30, right: 100, bottom: 60, left: 80 };
        const chartWidth = 700;
        const chartHeight = 500;
        const width = chartWidth - margin.left - margin.right;
        const height = chartHeight - margin.top - margin.bottom;

        // Extract unique categories for X and Y axes
        const approaches = Array.from(new Set(rawData.map(d => d.Approach)));
        // Datasets will be the X-axis categories
        const datasets = Array.from(new Set(rawData.map(d => d.Dataset)));

        // Sort the datasets for consistent display order
        const datasetOrder = ['CIFAR100', 'CIFAR10', 'SVHN', 'MNIST'];
        datasets.sort((a, b) => datasetOrder.indexOf(a) - datasetOrder.indexOf(b));

        // SVG setup
        const svg = d3.select("#heatmap")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Tooltip setup
        const tooltip = d3.select("#tooltip");

        // Scales
        const xScale = d3.scaleBand()
            .range([0, width])
            .domain(datasets)
            .padding(0.05);

        const yScale = d3.scaleBand()
            .range([height, 0])
            .domain(approaches)
            .padding(0.05);

        // Color Scale: Uses d3.interpolateViridis for the default green/yellow/blue gradient
        const colorScale = d3.scaleSequential()
            .interpolator(d3.interpolateViridis)
            .domain([0, 100]); // Values are percentages

        // Draw Axes
        // X-axis (Datasets)
        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(xScale).tickSize(0))
            .select(".domain").remove();

        svg.selectAll(".x-axis text")
            .attr("class", "axis-label")
            .attr("fill", "#374151") // Dark grey axis labels
            .attr("transform", "translate(0, 10)") // Move labels down

        // Y-axis (Approaches)
        svg.append("g")
            .attr("class", "y-axis")
            .call(d3.axisLeft(yScale).tickSize(0))
            .select(".domain").remove();

        svg.selectAll(".y-axis text")
            .attr("class", "axis-label")
            .attr("fill", "#1f2937") // Dark text for approach names
            .attr("font-size", "14px");


        /**
         * The main function to draw/update the heatmap based on the selected metric.
         * @param {string} selectedMetric - 'Std Acc', 'CRR', or 'CRA'
         */
        function updateChart(selectedMetric) {
            // 1. Filter the data based on the selected metric
            const filteredData = rawData.filter(d => d["Metric Group"] === selectedMetric);

            // 2. Data Join (rectangles)
            const cells = svg.selectAll(".cell")
                .data(filteredData, d => d.Approach + ':' + d.Dataset);

            // 3. EXIT Phase: Remove old cells
            cells.exit()
                .transition().duration(500)
                .attr("opacity", 0)
                .remove();

            // 4. UPDATE + ENTER Phase: Create new cells and update existing ones
            cells.enter()
                .append("rect")
                .attr("class", "cell")
                .attr("x", d => xScale(d.Dataset))
                .attr("y", d => yScale(d.Approach))
                .attr("width", xScale.bandwidth())
                .attr("height", yScale.bandwidth())
                .attr("rx", 5)
                .attr("ry", 5)
                .style("fill", "#cccccc") // Start color
                .attr("opacity", 0)

                // Append the transition to the ENTER selection
                .merge(cells)
                .on("mouseover", handleMouseOver)
                .on("mousemove", handleMouseMove)
                .on("mouseleave", handleMouseLeave)

                // Apply the main transition (Non-interaction-triggered)
                .transition().duration(1000)
                .ease(d3.easeCubicInOut)
                .attr("x", d => xScale(d.Dataset))
                .attr("y", d => yScale(d.Approach))
                .attr("opacity", 1)
                .style("fill", d => colorScale(d.Value));

            // 5. Add text labels to the cells
            const textLabels = svg.selectAll(".cell-text")
                .data(filteredData, d => d.Approach + ':' + d.Dataset);

            textLabels.exit().remove();

            // Append the transition to the ENTER selection
            textLabels.enter()
                .append("text")
                .attr("class", "cell-text")
                .style("fill", "white") // White text for contrast on Viridis map
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "middle")
                .attr("font-size", "10px")
                .attr("pointer-events", "none")
                .attr("opacity", 0)
                .merge(textLabels)
                .transition().duration(1000)
                .ease(d3.easeCubicInOut)
                .attr("x", d => xScale(d.Dataset) + xScale.bandwidth() / 2)
                .attr("y", d => yScale(d.Approach) + yScale.bandwidth() / 2)
                .attr("opacity", 1)
                .text(d => d.Value.toFixed(2)); // Still using 2 decimal places

            // Update the legend color domain
            updateLegend(colorScale, selectedMetric);
        }

        // --- Tooltip Interaction Functions ---

        function handleMouseOver(event, d) {
            // Show the tooltip (user-triggered interaction)
            tooltip.transition()
                .duration(200)
                .style("opacity", .9);
            
            tooltip.html(`
                <div class="font-bold">${d.Approach}</div>
                <div>${d.Dataset} - ${d["Metric Group"]}</div>
                <div class="text-indigo-400 text-lg">${d.Value.toFixed(2)}%</div>
            `);

            // Highlight the cell
            d3.select(this)
                .style("stroke", "#ffeb3b") // Yellow highlight
                .style("stroke-width", "3px");
        }

        function handleMouseMove(event) {
            // Position the tooltip relative to the mouse pointer
            tooltip.style("left", (event.pageX + 15) + "px")
                   .style("top", (event.pageY - 28) + "px");
        }

        function handleMouseLeave(event, d) {
            // Hide the tooltip
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);

            // Un-highlight the cell
            d3.select(this)
                .style("stroke", "#ffffff") // Reset to white stroke
                .style("stroke-width", "1px");
        }

        // --- Legend Function ---

        function updateLegend(colorScale, title) {
            const legendSvg = d3.select("#legend");
            const legendWidth = 300;
            const legendHeight = 20;

            // Clear previous content
            legendSvg.selectAll("*").remove();

            // Create a linear gradient for the color bar
            const linearGradient = legendSvg.append("defs")
                .append("linearGradient")
                .attr("id", "legend-gradient")
                .attr("x1", "0%")
                .attr("x2", "100%");

            // Add color stops based on the color scale's interpolator (Viridis)
            linearGradient.selectAll("stop")
                .data([
                    { offset: "0%", color: d3.interpolateViridis(0) },
                    { offset: "25%", color: d3.interpolateViridis(0.25) },
                    { offset: "50%", color: d3.interpolateViridis(0.5) },
                    { offset: "75%", color: d3.interpolateViridis(0.75) },
                    { offset: "100%", color: d3.interpolateViridis(1) }
                ])
                .enter().append("stop")
                .attr("offset", d => d.offset)
                .attr("stop-color", d => d.color);

            // Draw the color bar
            legendSvg.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .style("fill", "url(#legend-gradient)")
                .attr("rx", 4)
                .attr("ry", 4);

            // Create an axis for the legend
            const legendAxisScale = d3.scaleLinear()
                .range([0, legendWidth])
                .domain(colorScale.domain());

            const legendAxis = d3.axisBottom(legendAxisScale)
                .tickValues([0, 25, 50, 75, 100])
                .tickFormat(d => d + "%")
                .tickSize(6);

            legendSvg.append("g")
                .attr("class", "legend-axis")
                .attr("transform", `translate(0, ${legendHeight})`)
                .call(legendAxis)
                .select(".domain").remove(); // Remove the line segment on the axis

            legendSvg.selectAll(".legend-axis text")
                .attr("class", "axis-label");

            // Update title
            d3.select("#legend-container h3")
                .text(`Color Scale (Percentage Value for ${title})`);
        }


        // --- Initialization and Event Listener ---

        // Get the dropdown element
        const metricSelect = d3.select("#metric-select");

        // Set the initial value and draw the chart on load
        const initialMetric = metricSelect.property("value");
        updateChart(initialMetric);

        // Add event listener for the interaction (user-triggered update)
        metricSelect.on("change", function(event) {
            const newMetric = event.target.value;
            updateChart(newMetric);
        });

    </script>
</body>
</html>
