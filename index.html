<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDV Assignment 4 - Combined Data Visualization</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind for the light theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'light-bg': '#f7f9fb', // Very light background
                        'light-surface': '#ffffff', // White chart surface
                        'dark-text': '#1f2937', // Dark gray text
                        'primary-accent': '#4f46e5', // Indigo for interactive elements
                        'tab-active': '#4f46e5',
                        'tab-inactive': '#9ca3af',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Load D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Base Light Mode Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }

        /* Common Container Styles */
        .chart-container {
            background-color: #ffffff;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        /* Tooltip styling */
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px 12px;
            font-size: 14px;
            background: #1f2937;
            color: #ffffff;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        /* Heatmap Specific Styles */
        .cell {
            stroke: #ffffff;
            stroke-width: 1px;
            cursor: pointer;
        }

        /* Line Chart Specific Styles */
        .domain, .tick line {
            stroke: #d1d5db;
        }
        .axis-label {
            fill: #374151;
            font-weight: 500;
            font-size: 12px;
        }
        .approach-checkbox {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 8px;
            transition: background-color 0.2s;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        .approach-checkbox input {
            margin-right: 6px;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">IDV Assignment 4</h1>
            <p class="text-xl text-gray-500 mt-2">Data to Chart with D3.js</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-8">
            <button id="tab-heatmap" onclick="switchTab('heatmap')" 
                    class="py-2 px-4 text-lg font-medium border-b-2 transition-colors duration-300">
                Data Option 1: Metric Heatmap
            </button>
            <button id="tab-linechart" onclick="switchTab('linechart')" 
                    class="py-2 px-4 text-lg font-medium border-b-2 transition-colors duration-300">
                Data Option 2: Attack Line Chart
            </button>
        </div>

        <!-- Tab Content Containers -->
        
        <!-- HEATMAP TAB CONTENT (Data Option 1) -->
        <div id="content-heatmap" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Metric Comparison by Dataset</h2>
            
            <!-- Interaction Control: Dropdown for Metric Selection -->
            <div class="flex flex-col sm:flex-row items-center justify-start space-y-4 sm:space-y-0 sm:space-x-8 mb-8 p-4 bg-white rounded-xl shadow-md">
                <label for="metric-select" class="text-lg font-semibold text-indigo-600">Select Performance Metric:</label>
                <select id="metric-select" class="shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 p-2 rounded-lg border border-gray-300">
                    <option value="Std Acc">Standard Accuracy (Std Acc)</option>
                    <option value="CRR">Certified Robustness Rate (CRR)</option>
                    <option value="CRA">Certified Robust Accuracy (CRA)</option>
                </select>
            </div>

            <!-- Visualization Container -->
            <div id="visualization-container-1" class="chart-container p-6 rounded-xl">
                <svg id="heatmap"></svg>
            </div>

            <!-- Legend -->
            <div id="legend-container" class="mt-8 chart-container p-6 rounded-xl">
                <h3 class="text-lg font-semibold mb-2">Color Scale (Percentage Value)</h3>
                <svg id="legend" width="300" height="40"></svg>
            </div>
        </div>

        <!-- LINE CHART TAB CONTENT (Data Option 2) -->
        <div id="content-linechart" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Attack Vulnerability Profiles</h2>

            <!-- Interaction Control: Checkboxes for Approach Selection -->
            <div id="controls-2" class="p-4 rounded-xl mb-8 chart-container">
                <h3 class="text-lg font-semibold text-primary-accent mb-3">Select Approaches to Compare (Interaction)</h3>
                <div id="approach-controls" class="flex flex-wrap gap-4">
                    <!-- Checkboxes will be populated here -->
                </div>
            </div>

            <!-- Visualization Container -->
            <div id="visualization-container-2" class="chart-container p-6 rounded-xl">
                <svg id="linechart"></svg>
            </div>
        </div>

        <!-- Tooltip Element (Shared) -->
        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // --- DATA DEFINITION (Shared) ---
        
        // Data Option 1 (Heatmap)
        const rawData1 = [
            {"Approach": "ERM", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 81.03},
            {"Approach": "DA", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 78.27},
            {"Approach": "PGDT", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 64.35},
            {"Approach": "TRADES", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 62.55},
            {"Approach": "MART", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 63.68},
            {"Approach": "RS", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 56.87},
            {"Approach": "IBP", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 39.45},
            {"Approach": "PRL", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 64.89},
            {"Approach": "TandT", "Metric Group": "Std Acc", "Dataset": "CIFAR100", "Value": 65.56},
            {"Approach": "ERM", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 94.85},
            {"Approach": "DA", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 94.21},
            {"Approach": "PGDT", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 84.38},
            {"Approach": "TRADES", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 80.42},
            {"Approach": "MART", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 81.54},
            {"Approach": "RS", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 89.45},
            {"Approach": "IBP", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 48.4},
            {"Approach": "PRL", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 93.82},
            {"Approach": "TandT", "Metric Group": "Std Acc", "Dataset": "CIFAR10", "Value": 94.23},
            {"Approach": "ERM", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 94.44},
            {"Approach": "DA", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 94.69},
            {"Approach": "PGDT", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 91.19},
            {"Approach": "TRADES", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 86.16},
            {"Approach": "MART", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 90.2},
            {"Approach": "RS", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 88.35},
            {"Approach": "IBP", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 73.09},
            {"Approach": "PRL", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 92},
            {"Approach": "TandT", "Metric Group": "Std Acc", "Dataset": "SVHN", "Value": 94.79},
            {"Approach": "ERM", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.37},
            {"Approach": "DA", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.42},
            {"Approach": "PGDT", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.16},
            {"Approach": "TRADES", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.1},
            {"Approach": "MART", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 98.94},
            {"Approach": "RS", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 97.16},
            {"Approach": "IBP", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 97.78},
            {"Approach": "PRL", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.32},
            {"Approach": "TandT", "Metric Group": "Std Acc", "Dataset": "MNIST", "Value": 99.32},
            {"Approach": "ERM", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 9.28},
            {"Approach": "DA", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 15.04},
            {"Approach": "PGDT", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 57.07},
            {"Approach": "TRADES", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 59.27},
            {"Approach": "MART", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 58.79},
            {"Approach": "RS", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 60.38},
            {"Approach": "IBP", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 49.34},
            {"Approach": "PRL", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 56.71},
            {"Approach": "TandT", "Metric Group": "CRR", "Dataset": "CIFAR100", "Value": 62.05},
            {"Approach": "ERM", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 1.25},
            {"Approach": "DA", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 81.08},
            {"Approach": "PGDT", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 87.07},
            {"Approach": "TRADES", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 88.54},
            {"Approach": "MART", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 78.9},
            {"Approach": "RS", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 90},
            {"Approach": "IBP", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 54.7},
            {"Approach": "PRL", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 90.71},
            {"Approach": "TandT", "Metric Group": "CRR", "Dataset": "CIFAR10", "Value": 95.08},
            {"Approach": "ERM", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 52.72},
            {"Approach": "DA", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 82.08},
            {"Approach": "PGDT", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 87.89},
            {"Approach": "TRADES", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 87.89},
            {"Approach": "MART", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 85.23},
            {"Approach": "RS", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 76.29},
            {"Approach": "IBP", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 61.94},
            {"Approach": "PRL", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 93.11},
            {"Approach": "TandT", "Metric Group": "CRR", "Dataset": "SVHN", "Value": 93.15},
            {"Approach": "ERM", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 26.01},
            {"Approach": "DA", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 85.23},
            {"Approach": "PGDT", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 94.65},
            {"Approach": "TRADES", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 94.76},
            {"Approach": "MART", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 94.13},
            {"Approach": "RS", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 87.15},
            {"Approach": "IBP", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 89.18},
            {"Approach": "PRL", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 96.03},
            {"Approach": "TandT", "Metric Group": "CRR", "Dataset": "MNIST", "Value": 97.8},
            {"Approach": "ERM", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 4.52},
            {"Approach": "DA", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 6.15},
            {"Approach": "PGDT", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 32.93},
            {"Approach": "TRADES", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 38.85},
            {"Approach": "MART", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 49.37},
            {"Approach": "RS", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 47.5},
            {"Approach": "IBP", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 29.2},
            {"Approach": "PRL", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 50.77},
            {"Approach": "TandT", "Metric Group": "CRA", "Dataset": "CIFAR100", "Value": 52.07},
            {"Approach": "ERM", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 1.25},
            {"Approach": "DA", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 76.07},
            {"Approach": "PGDT", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 82.9},
            {"Approach": "TRADES", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 78.8},
            {"Approach": "MART", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 72.21},
            {"Approach": "RS", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 87.98},
            {"Approach": "IBP", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 40},
            {"Approach": "PRL", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 90.63},
            {"Approach": "TandT", "Metric Group": "CRA", "Dataset": "CIFAR10", "Value": 91.75},
            {"Approach": "ERM", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 51.04},
            {"Approach": "DA", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 82.01},
            {"Approach": "PGDT", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 86.68},
            {"Approach": "TRADES", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 84.76},
            {"Approach": "MART", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 78.82},
            {"Approach": "RS", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 70.64},
            {"Approach": "IBP", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 57.26},
            {"Approach": "PRL", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 91.07},
            {"Approach": "TandT", "Metric Group": "CRA", "Dataset": "SVHN", "Value": 92.81},
            {"Approach": "ERM", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 24.96},
            {"Approach": "DA", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 84.12},
            {"Approach": "PGDT", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 94.63},
            {"Approach": "TRADES", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 94.61},
            {"Approach": "MART", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 94.09},
            {"Approach": "RS", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 86.29},
            {"Approach": "IBP", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 88.51},
            {"Approach": "PRL", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 95.01},
            {"Approach": "TandT", "Metric Group": "CRA", "Dataset": "MNIST", "Value": 96.8}
        ];

        // Data Option 2 (Line Chart)
        const rawData2 = [
            {"Attack": "No Attack", "ERM": 94.85, "DA": 94.21, "PGDT": 84.38, "TRADES": 80.42, "MART": 81.54, "RS": 89.45, "IBP": 48.4, "PRL": 93.82, "TandT": 94.23},
            {"Attack": "TIFGSM", "ERM": 35.1, "DA": 33, "PGDT": 65.7, "TRADES": 62.9, "MART": 69.1, "RS": 45.4, "IBP": 40.2, "PRL": 34, "TandT": 92.8},
            {"Attack": "MIFGSM", "ERM": 0, "DA": 0, "PGDT": 50.9, "TRADES": 51.9, "MART": 50.5, "RS": 5.8, "IBP": 38.1, "PRL": 0, "TandT": 92.8},
            {"Attack": "DIFGSM", "ERM": 1, "DA": 0, "PGDT": 51.75, "TRADES": 50.5, "MART": 53.6, "RS": 4.1, "IBP": 38.1, "PRL": 3.1, "TandT": 92.8},
            {"Attack": "VMIFGSM", "ERM": 0, "DA": 0, "PGDT": 51.1, "TRADES": 50.9, "MART": 51.9, "RS": 4.1, "IBP": 38.1, "PRL": 0, "TandT": 93.9},
            {"Attack": "TPGD", "ERM": 38.1, "DA": 39.2, "PGDT": 69.3, "TRADES": 69.1, "MART": 70.1, "RS": 48.5, "IBP": 50, "PRL": 28.9, "TandT": 91.8},
            {"Attack": "FGSM", "ERM": 29.9, "DA": 25.8, "PGDT": 57.95, "TRADES": 54.6, "MART": 61.9, "RS": 28.9, "IBP": 38.1, "PRL": 25.8, "TandT": 93.8},
            {"Attack": "RFGSM", "ERM": 0, "DA": 0, "PGDT": 49.15, "TRADES": 50.4, "MART": 48.5, "RS": 3.7, "IBP": 38.1, "PRL": 0, "TandT": 90},
            {"Attack": "BIM", "ERM": 0, "DA": 0, "PGDT": 52, "TRADES": 57.2, "MART": 47.4, "RS": 2.1, "IBP": 38.1, "PRL": 0, "TandT": 90.7},
            {"Attack": "FAB", "ERM": 1, "DA": 2.1, "PGDT": 43, "TRADES": 46.4, "MART": 40.2, "RS": 5.3, "IBP": 38.1, "PRL": 4.1, "TandT": 90.1},
            {"Attack": "CW", "ERM": 0, "DA": 0, "PGDT": 32.2, "TRADES": 35.1, "MART": 29.9, "RS": 1, "IBP": 40.2, "PRL": 1, "TandT": 92.9},
            {"Attack": "UPGD", "ERM": 0, "DA": 0, "PGDT": 49.85, "TRADES": 50.5, "MART": 49.8, "RS": 5.1, "IBP": 38.1, "PRL": 0, "TandT": 93.8},
            {"Attack": "FFGSM", "ERM": 19.6, "DA": 23.7, "PGDT": 60.55, "TRADES": 55.7, "MART": 66, "RS": 33, "IBP": 42.3, "PRL": 29.9, "TandT": 92.8},
            {"Attack": "Jitter", "ERM": 11.3, "DA": 12.4, "PGDT": 48.15, "TRADES": 47.4, "MART": 49.5, "RS": 34, "IBP": 39.2, "PRL": 24.7, "TandT": 90.7},
            {"Attack": "PGD", "ERM": 0, "DA": 0, "PGDT": 57.4, "TRADES": 54.6, "MART": 60.8, "RS": 7.2, "IBP": 40.2, "PRL": 0, "TandT": 91.8},
            {"Attack": "EOTPGD", "ERM": 0, "DA": 0, "PGDT": 50.1, "TRADES": 50.3, "MART": 50.5, "RS": 3, "IBP": 38.1, "PRL": 0, "TandT": 90.7},
            {"Attack": "APGD", "ERM": 0, "DA": 0, "PGDT": 48.4, "TRADES": 51, "MART": 46.4, "RS": 1, "IBP": 38.1, "PRL": 0, "TandT": 90.7},
            {"Attack": "NIFGSM", "ERM": 0, "DA": 0, "PGDT": 57.95, "TRADES": 56.7, "MART": 59.8, "RS": 7.2, "IBP": 38.1, "PRL": 1, "TandT": 92.8},
            {"Attack": "SiniFGSM", "ERM": 4.1, "DA": 1, "PGDT": 59, "TRADES": 56.7, "MART": 61.9, "RS": 23.7, "IBP": 38.1, "PRL": 12.4, "TandT": 93.7},
            {"Attack": "VNIFGSM", "ERM": 0, "DA": 0, "PGDT": 50.45, "TRADES": 53, "MART": 48.5, "RS": 5.1, "IBP": 38.1, "PRL": 0, "TandT": 92.9},
            {"Attack": "APGDT", "ERM": 0, "DA": 0, "PGDT": 40.9, "TRADES": 44.3, "MART": 38.1, "RS": 0, "IBP": 38.1, "PRL": 0, "TandT": 88.7},
            {"Attack": "Square", "ERM": 0, "DA": 1, "PGDT": 50.4, "TRADES": 54, "MART": 47.4, "RS": 3.1, "IBP": 38.1, "PRL": 2.1, "TandT": 88.08},
            {"Attack": "Add Gaussian Noise", "ERM": 25.8, "DA": 43.3, "PGDT": 79.1, "TRADES": 78.4, "MART": 80.4, "RS": 74.2, "IBP": 42.3, "PRL": 45.4, "TandT": 87.6},
            {"Attack": "OnePixel", "ERM": 79.4, "DA": 83.5, "PGDT": 78.05, "TRADES": 74.2, "MART": 82.5, "RS": 83.5, "IBP": 42.5, "PRL": 80.4, "TandT": 89.7},
            {"Attack": "Pixle", "ERM": 0, "DA": 0, "PGDT": 12.55, "TRADES": 11.3, "MART": 14.4, "RS": 1, "IBP": 10.3, "PRL": 0, "TandT": 17.5},
            {"Attack": "PGDL2", "ERM": 1, "DA": 0, "PGDT": 35.8, "TRADES": 36.1, "MART": 36.1, "RS": 5.2, "IBP": 36.1, "PRL": 0, "TandT": 92.9}
        ];
        
        // --- GLOBAL STATE ---
        let currentTab = 'heatmap';
        
        // State for Heatmap (Chart 1)
        let heatmapInitialized = false;
        let selectedMetric = 'Std Acc';
        const colorStopsNoGreen = ['#440154', '#300063', '#a42967', '#ff8c00'];
        
        // State for Line Chart (Chart 2)
        let lineChartInitialized = false;
        let visibleApproaches = ["TandT", "PGDT", "ERM"];
        
        // Common Dimensions
        const margin1 = { top: 30, right: 100, bottom: 60, left: 80 };
        const chartWidth1 = 700;
        const chartHeight1 = 500;
        const width1 = chartWidth1 - margin1.left - margin1.right;
        const height1 = chartHeight1 - margin1.top - margin1.bottom;

        const margin2 = { top: 40, right: 100, bottom: 80, left: 60 };
        const chartWidth2 = 900;
        const chartHeight2 = 500;
        const width2 = chartWidth2 - margin2.left - margin2.right;
        const height2 = chartHeight2 - margin2.top - margin2.bottom;
        
        // Tooltip selection (must be global)
        const tooltip = d3.select("#tooltip");

        // --- TAB SWITCHING LOGIC ---

        function switchTab(tabId) {
            // Update button styles
            d3.select('#tab-heatmap').classed('text-primary-accent border-primary-accent', tabId === 'heatmap')
                                     .classed('text-tab-inactive border-transparent hover:text-gray-700', tabId !== 'heatmap');
            d3.select('#tab-linechart').classed('text-primary-accent border-primary-accent', tabId === 'linechart')
                                       .classed('text-tab-inactive border-transparent hover:text-gray-700', tabId !== 'linechart');

            // Toggle content visibility
            d3.select('#content-heatmap').classed('hidden', tabId !== 'heatmap');
            d3.select('#content-linechart').classed('hidden', tabId !== 'linechart');
            
            currentTab = tabId;

            // Initialize or redraw the chart when switching to its tab
            if (tabId === 'heatmap' && !heatmapInitialized) {
                initChart1();
            } else if (tabId === 'linechart' && !lineChartInitialized) {
                initChart2();
            }
        }

        // --- CHART 1 (HEATMAP) LOGIC ---
        
        function initChart1() {
            heatmapInitialized = true;

            const approaches = Array.from(new Set(rawData1.map(d => d.Approach)));
            const datasets = ['CIFAR100', 'CIFAR10', 'SVHN', 'MNIST']; // Consistent order
            
            const colorScale = d3.scaleSequential([0, 100], d3.interpolateRgbBasis(colorStopsNoGreen));

            const svg = d3.select("#heatmap")
                .attr("width", chartWidth1)
                .attr("height", chartHeight1)
                .append("g")
                .attr("transform", `translate(${margin1.left},${margin1.top})`);

            const xScale = d3.scaleBand()
                .range([0, width1])
                .domain(datasets)
                .padding(0.05);

            const yScale = d3.scaleBand()
                .range([height1, 0])
                .domain(approaches)
                .padding(0.05);

            // X-axis
            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0, ${height1})`)
                .call(d3.axisBottom(xScale).tickSize(0))
                .select(".domain").remove();
            svg.selectAll(".x-axis text").attr("class", "axis-label").attr("transform", "translate(0, 10)");

            // Y-axis
            svg.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(yScale).tickSize(0))
                .select(".domain").remove();
            svg.selectAll(".y-axis text").attr("class", "axis-label").attr("font-size", "14px");


            // Draw/Update function for Heatmap
            function updateChart1(metric) {
                const filteredData = rawData1.filter(d => d["Metric Group"] === metric);

                // --- Rectangles (Cells) ---
                const cells = svg.selectAll(".cell")
                    .data(filteredData, d => d.Approach + ':' + d.Dataset);

                cells.exit().transition().duration(500).attr("opacity", 0).remove();

                cells.enter()
                    .append("rect")
                    .attr("class", "cell")
                    .attr("x", d => xScale(d.Dataset))
                    .attr("y", d => yScale(d.Approach))
                    .attr("width", xScale.bandwidth())
                    .attr("height", yScale.bandwidth())
                    .attr("rx", 5).attr("ry", 5)
                    .style("fill", "#cccccc")
                    .attr("opacity", 0)
                    .merge(cells)
                    .on("mouseover", function(event, d) { handleMouseOver1(event, d, colorScale); })
                    .on("mousemove", handleMouseMove)
                    .on("mouseleave", handleMouseLeave)
                    .transition().duration(1000).ease(d3.easeCubicInOut)
                    .attr("x", d => xScale(d.Dataset))
                    .attr("y", d => yScale(d.Approach))
                    .attr("opacity", 1)
                    .style("fill", d => colorScale(d.Value));

                // --- Text Labels ---
                const textLabels = svg.selectAll(".cell-text")
                    .data(filteredData, d => d.Approach + ':' + d.Dataset);

                textLabels.exit().remove();

                textLabels.enter()
                    .append("text")
                    .attr("class", "cell-text")
                    .style("fill", "white")
                    .attr("text-anchor", "middle").attr("alignment-baseline", "middle")
                    .attr("font-size", "10px").attr("pointer-events", "none")
                    .attr("opacity", 0)
                    .merge(textLabels)
                    .transition().duration(1000).ease(d3.easeCubicInOut)
                    .attr("x", d => xScale(d.Dataset) + xScale.bandwidth() / 2)
                    .attr("y", d => yScale(d.Approach) + yScale.bandwidth() / 2)
                    .attr("opacity", 1)
                    .text(d => d.Value.toFixed(2));

                updateLegend1(colorScale, metric);
            }

            // Tooltip Handlers for Chart 1
            function handleMouseOver1(event, d, colorScale) {
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`
                    <div class="font-bold">${d.Approach}</div>
                    <div>${d.Dataset} - ${d["Metric Group"]}</div>
                    <div class="text-orange-400 text-lg">${d.Value.toFixed(2)}%</div>
                `);
                d3.select(event.currentTarget).style("stroke", "#FFA726").style("stroke-width", "3px");
            }

            // Legend function for Chart 1
            function updateLegend1(colorScale, title) {
                const legendSvg = d3.select("#legend");
                const legendWidth = 300;
                const legendHeight = 20;
                legendSvg.selectAll("*").remove();

                const linearGradient = legendSvg.append("defs").append("linearGradient")
                    .attr("id", "legend-gradient-1").attr("x1", "0%").attr("x2", "100%");
                
                linearGradient.selectAll("stop")
                    .data(colorStopsNoGreen)
                    .enter().append("stop")
                    .attr("offset", (d, i) => {
                        if (i === 0) return "0%";
                        if (i === colorStopsNoGreen.length - 1) return "100%";
                        return `${Math.round(i * (100 / (colorStopsNoGreen.length - 1)))}%`;
                    })
                    .attr("stop-color", d => d);

                legendSvg.append("rect")
                    .attr("x", 0).attr("y", 0).attr("width", legendWidth).attr("height", legendHeight)
                    .style("fill", "url(#legend-gradient-1)").attr("rx", 4).attr("ry", 4);

                const legendAxisScale = d3.scaleLinear().range([0, legendWidth]).domain(colorScale.domain());
                const legendAxis = d3.axisBottom(legendAxisScale).tickValues([0, 25, 50, 75, 100]).tickFormat(d => d + "%").tickSize(6);

                legendSvg.append("g").attr("class", "legend-axis")
                    .attr("transform", `translate(0, ${legendHeight})`).call(legendAxis).select(".domain").remove();
                
                legendSvg.selectAll(".legend-axis text").attr("class", "axis-label");

                d3.select("#legend-container h3").text(`Color Scale (Percentage Value for ${title})`);
            }

            // Initial Draw for Chart 1
            updateChart1(selectedMetric);

            // Event Listener for Chart 1
            d3.select("#metric-select").on("change", function(event) {
                selectedMetric = event.target.value;
                updateChart1(selectedMetric);
            });
        }
        
        // --- CHART 2 (LINE CHART) LOGIC ---
        
        function initChart2() {
            lineChartInitialized = true;
            
            const approaches = Object.keys(rawData2[0]).filter(key => key !== 'Attack');
            const attacks = rawData2.map(d => d.Attack);

            const dataLong = approaches.flatMap(approach => {
                return rawData2.map(d => ({ attack: d.Attack, approach: approach, value: d[approach] }));
            });
            const dataNested = d3.group(dataLong, d => d.approach);

            // Color Scale (Consistent with Heatmap Tones: Purples, Pinks, Reds, Blues, and Oranges/Golds)
            const customColorPalette = [
                '#FF8C00', // Strong Orange (TandT)
                '#E53935', // Red (PRL)
                '#42A5F5', // Medium Blue (PGDT)
                '#7E57C2', // Deep Violet (IBP)
                '#FFB300', // Gold/Amber (DA)
                '#AB47BC', // Purple (TRADES)
                '#EC407A', // Pink/Magenta (MART)
                '#1565C0', // Dark Blue (ERM)
                '#26A69A', // Teal-ish (RS)
            ];
            const colorScale = d3.scaleOrdinal().domain(approaches).range(customColorPalette);

            const svg = d3.select("#linechart")
                .attr("viewBox", `0 0 ${chartWidth2} ${chartHeight2}`)
                .append("g")
                .attr("transform", `translate(${margin2.left},${margin2.top})`);
            
            const xScale = d3.scalePoint().domain(attacks).range([0, width2]);
            const yScale = d3.scaleLinear().domain([0, 100]).range([height2, 0]);
            
            const line = d3.line()
                .x(d => xScale(d.attack)).y(d => yScale(d.value));

            // --- Draw Axes ---
            const xAxis = svg.append("g").attr("class", "x-axis").attr("transform", `translate(0, ${height2})`).call(d3.axisBottom(xScale).tickSizeOuter(0));
            xAxis.selectAll("text").attr("class", "axis-label").style("text-anchor", "end").attr("dx", "-.8em").attr("dy", ".15em").attr("transform", "rotate(-45)");
            svg.append("text").attr("class", "axis-label").attr("x", width2 / 2).attr("y", height2 + margin2.bottom - 10).style("fill", "#374151").text("Adversarial Attack Type");

            const yAxis = svg.append("g").attr("class", "y-axis").call(d3.axisLeft(yScale));
            svg.append("text").attr("class", "axis-label").attr("transform", "rotate(-90)").attr("y", 0 - margin2.left).attr("x", 0 - (height2 / 2)).attr("dy", "1em").style("text-anchor", "middle").style("fill", "#374151").text("Accuracy (%)");


            // --- Interaction Control Setup (Checkboxes) ---
            const controlsContainer = d3.select("#approach-controls");
            
            approaches.forEach(approach => {
                const isChecked = visibleApproaches.includes(approach);
                const label = controlsContainer.append("label")
                    .attr("class", "approach-checkbox")
                    .style("color", colorScale(approach))
                    .style("border", `2px solid ${colorScale(approach)}`);

                label.append("input").attr("type", "checkbox")
                    .attr("checked", isChecked ? true : null).attr("value", approach).on("change", handleCheckboxChange);
                label.append("span").text(approach);
            });

            function handleCheckboxChange(event) {
                const approach = event.target.value;
                if (event.target.checked) {
                    if (!visibleApproaches.includes(approach)) { visibleApproaches.push(approach); }
                } else {
                    visibleApproaches = visibleApproaches.filter(a => a !== approach);
                }
                updateChart2();
            }

            // Draw/Update function for Line Chart
            function updateChart2() {
                const dataFiltered = new Map(
                    Array.from(dataNested).filter(([key]) => visibleApproaches.includes(key))
                );

                // 1. Data Join (Line Paths)
                const lines = svg.selectAll(".approach-line")
                    .data(dataFiltered, d => d[0]);

                lines.exit().transition().duration(500).style("opacity", 0).remove();

                const linesEnter = lines.enter().append("path")
                    .attr("class", "approach-line").attr("fill", "none").attr("stroke-width", 2)
                    .attr("stroke", d => colorScale(d[0])).style("opacity", 0);

                linesEnter.merge(lines)
                    .attr("d", d => line(d[1]))
                    .each(function() { // Line Drawing Transition (Non-interaction-triggered)
                        const path = d3.select(this);
                        const totalLength = path.node().getTotalLength();
                        path.attr("stroke-dasharray", totalLength + " " + totalLength)
                            .attr("stroke-dashoffset", totalLength).style("opacity", 1);
                    })
                    .transition().duration(1500).ease(d3.easeCubicInOut)
                    .attr("stroke-dashoffset", 0);

                // 2. Data Points (Circles)
                const allPoints = Array.from(dataFiltered).flatMap(([key, values]) => values);
                const points = svg.selectAll(".data-point").data(allPoints, d => d.approach + ":" + d.attack);

                points.exit().transition().duration(500).attr("r", 0).remove();
                
                points.enter().append("circle").attr("class", "data-point").attr("r", 4)
                    .attr("cx", d => xScale(d.attack)).attr("cy", d => yScale(d.value))
                    .attr("fill", d => colorScale(d.approach)).style("opacity", 0)
                    .on("mouseover", handleMouseOver2).on("mousemove", handleMouseMove).on("mouseleave", handleMouseLeave)
                    .merge(points)
                    .transition().duration(1500).ease(d3.easeCubicInOut)
                    .attr("cx", d => xScale(d.attack)).attr("cy", d => yScale(d.value)).style("opacity", 1).attr("r", 4);
            }

            // Tooltip Handlers for Chart 2
            function handleMouseOver2(event, d) {
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`
                    <div class="font-bold">${d.approach}</div>
                    <div class="text-xs text-gray-600 mb-1">${d.attack}</div>
                    <div class="text-indigo-600 text-lg">${d.value.toFixed(2)}%</div>
                `);
                d3.select(event.currentTarget).transition().duration(200).attr("r", 7).style("stroke", "white").style("stroke-width", 2);
            }

            // Initial Draw for Chart 2
            updateChart2();
        }

        // --- COMMON TOOLTIP HANDLERS ---
        function handleMouseMove(event) {
            tooltip.style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
        }

        function handleMouseLeave(event) {
            tooltip.transition().duration(500).style("opacity", 0);
            
            if (currentTab === 'heatmap') {
                d3.select(event.currentTarget).style("stroke", "#ffffff").style("stroke-width", "1px");
            } else if (currentTab === 'linechart') {
                d3.select(event.currentTarget).transition().duration(200).attr("r", 4).style("stroke-width", 0);
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Start on the heatmap tab
            switchTab('heatmap');
        });

    </script>
</body>
</html>
